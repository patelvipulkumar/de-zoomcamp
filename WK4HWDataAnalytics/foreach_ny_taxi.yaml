id: foreach_ny_taxi
namespace: zoomcamp

inputs:
  - id: taxi_type
    type: ARRAY
    itemType: STRING    
    defaults: ["yellow","green"]

  - id: year
    type: ARRAY
    itemType: STRING     
    defaults: ["2019","2020"]
  
  - id: month
    type: ARRAY
    itemType: STRING
    defaults: ["01","02","03","04","05","06","07","08","09","10","11","12"]


tasks:
  - id: loop_over_taxi_type
    type: io.kestra.plugin.core.flow.ForEach
    values: "{{inputs.taxi_type}}"
    tasks:
      - id: loop_over_year
        type: io.kestra.plugin.core.flow.ForEach
        values: "{{inputs.year }}"
        tasks:
          - id: loop_over_month
            type: io.kestra.plugin.core.flow.ForEach
            values: "{{inputs.month }}"             
            tasks:
              - id: load_taxi_data_to_gcs_gbq
                type: io.kestra.plugin.core.flow.Subflow
                namespace: zoomcamp
                flowId: load_taxi_data_to_gcs_gbq
                wait: true
                transmitFailed: false
                inputs:
                  taxi: "{{parents[1].taskrun.value}}"
                  year: "{{parents[0].taskrun.value}}"
                  month: "{{taskrun.value}}"    
